{# this generates JFD  specific config for aggregation devices. It will be merged with the config generated by the common role before it is applied to the device #}
{# Configuration of the Cluster and FPC Ids #}
system {
    static-host-mapping {
        {{ jfd.peer_name }} inet {{ jfd.peer_ip }};
    }
    commit {
        peers {
            {{ jfd.peer_name }} {
                user root;
                authentication "$9$NsdbYkqfQz6Yg5QF/0O8X7Nb2aZj"; ## SECRET-DATA
            }
        }
    }
}
chassis {
    satellite-management {
        redundancy-groups {
            chassis-id  {{ jfd.chassis_id }};
            JFD {
                redundancy-group-id 1;
                peer-chassis-id  {{ jfd.peer_chassis_id }} inter-chassis-link {{ jfd.icl_interface }};
                satellite all;
            }
        }
        uplink-failure-detection;
        auto-satellite-conversion {
            satellite all;
        }
        port-group-alias {
            uplink-ports {
	            pic 0 {
		            ports [48, 49, 50, 51];
	            }
            }
        }
{% for fpc in jfd.links.to_satellite %}
        fpc {{ fpc.id }} {
            alias {{ fpc.name }};
{% for link in fpc.links %}
            cascade-ports {{ link }};
{% endfor %}
        }
{% endfor %}
    }
}
interfaces {
{# Configure ICL link #}
    {{ mclag.icl_interface }} {
        description "ICCP interface to Peer device";
        unit 0 {
{#             family ethernet-switching {
                interface-mode trunk;
                vlan {
                    members {{ mclag_shared.iccp.vlan_id }};
                }
            } #}
        }
    }
{% for link in jfd.links.to_peer %}
    {{ link }} {
        ether-options {
            802.3ad {{ mclag.icl_interface }};
        }
    }
{% endfor %}
{# Configure Cascade ports #}
{% for fpc in jfd.links.to_satellite %}
{% for link in fpc.links %}
    {{ link }} {
        cascade-port;
    }
{% endfor %}
{% endfor %}

{# IRB are not configured under Group JFD because each AD need unique info #}
{# Server Ports are configured under Group JFD for synchronization #}
    irb {
{% for vlan in vlans %}
{% if vlan.ip is defined %}
        unit {{ vlan.id }} {
            family inet {
{% if vlan.vip is defined %}
                address {{ vlan.ip }}/{{ vlan.mask }} {
                    vrrp-group 10 {
                        virtual-address {{ vlan.ip }};
                        accept-data;
                        priority 255;
                    }
                }
{% else %}
                address {{ vlan.ip }}/{{ vlan.mask }};
{% endif %}
            }
        }
{% endif %}
{% endfor %}
    }
}

{# Everything in this group will be replicated between AD #}
groups {
    JFD {
        when {
            peers [ {{ inventory_hostname }} {{ jfd.peer_name }} ];
        }
        interfaces {
{# Create AE facing server #}
{% set ae_index = 1 %}
{% for server_group in jfd.links.to_servers %}
            ae{{ ae_index }} {
                description "{{ server_group.description }}"
                aggregated-ether-options {
                    lacp {
                        active;
                        periodic fast;
                    }
                }
                unit 0 {
                    family ethernet-switching {
                        interface-mode trunk;
                        vlan {
{% for vlan in server_group.vlans %}
                            members {{ vlan }};
{% endfor %}
                        }
                    }
                }
            }
{# Associate physical interface with AE #}
{% for link in server_group.links %}
            {{ link }} {
                ether-options {
                    802.3ad ae{{ ae_index }};
                }
            }
{% endfor %}
{% set ae_index = ae_index + 1 %}
{% endfor %}
        }
{% set nbr_ae = jfd.links.to_servers|length + 2 %}
        chassis {
            aggregated-devices {
                ethernet {
                    device-count {{ nbr_ae }};
                }
            }
        }
{# Create Vlans and associate IRB to it if available #}
        vlans {
{% for vlan in vlans %}
            {{ vlan.name }} {
                vlan-id {{ vlan.id }};
{% if vlan.ip is defined %}
                l3-interface irb.{{ vlan.id }};
{% endif %}
            }
{% endfor %}
        }
    }
}
